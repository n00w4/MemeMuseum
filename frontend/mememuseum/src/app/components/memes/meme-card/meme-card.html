<div class="meme-card">
  <div class="meme-image">
    <img
      [src]="meme.image"
      [alt]="meme.title"
      priority
    />
  </div>

  <div class="meme-info">
    <h3 class="meme-title">{{ meme.title }}</h3>

    <div class="meme-meta">
      <span class="uploader">By {{ meme.uploader }}</span>
      <span class="date">{{ meme.uploadDate | date : "shortDate" }}</span>
    </div>

    <div class="meme-stats">
      <div class="rating" [class]="getRatingClass(meme.rating)">
        {{ meme.rating }}
      </div>
    </div>

    <div class="meme-tags">
      @for (tag of meme.tags; track tag) {
      <span class="tag">{{ tag }}</span>
      }
    </div>

    @if (isLoggedIn) {
    <div class="meme-actions">
      <button
        class="action-btn upvote"
        [class.active]="isUpvoteActive()"
        [disabled]="isLoading()"
        (click)="handleVote(1)"
      >
        <svg class="action-icon" viewBox="0 0 24 24">
          <path d="M12 3L2 14h7v7h6v-7h7z" />
        </svg>
        Upvote
      </button>

      <button
        class="action-btn downvote"
        [class.active]="isDownvoteActive()"
        [disabled]="isLoading()"
        (click)="handleVote(-1)"
      >
        <svg class="action-icon" viewBox="0 0 24 24">
          <path d="M12 21L2 10h7V3h6v7h7z" />
        </svg>
        Downvote
      </button>

      <button class="action-btn comment" (click)="toggleComments()">
        <svg class="action-icon" viewBox="0 0 24 24">
          <path
            d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"
          />
        </svg>
        Comment ({{
          meme.commentsCount !== undefined
            ? meme.commentsCount
            : comments().length
        }})
      </button>
    </div>

    @if (showComments()) {
    <div class="meme-comments">
      @if (commentLoadError()) {
      <div class="comment-error">
        {{ commentLoadError() }}

        <button class="retry-btn" (click)="loadComments()">Retry</button>
      </div>
      }

      <form
        class="new-comment-form"
        (ngSubmit)="submitComment()"
        #commentForm="ngForm"
      >
        <div class="comment-input-wrapper">
          <textarea
            class="comment-input"
            [(ngModel)]="newComment"
            name="newComment"
            placeholder="Add a comment..."
            rows="3"
            required
            [disabled]="isCommenting()"
          ></textarea>

          @if (commentSubmitError()) {
          <div class="comment-error">
            {{ commentSubmitError() }}
          </div>
          }
        </div>
        <div class="comment-actions">
          <button
            type="submit"
            class="submit-comment-btn"
            [disabled]="
              isCommenting() || !commentForm.form.valid || !newComment().trim()
            "
          >
            @if (isCommenting()) {
            <span>Posting...</span>
            } @else {
            <span>Post</span>
            }
          </button>
        </div>
      </form>

      <div class="comments-list">
        @if (comments().length > 0) { @for (comment of comments(); track
        comment.id) {
        <div class="comment">
          <div class="comment-meta">
            <span class="comment-author">User {{ comment.user_id }}</span>
            <span class="comment-date">{{
              comment.createdAt | date : "dd/MM/yyyy, HH:mm"
            }}</span>
          </div>
          <div class="comment-content">{{ comment.content }}</div>
        </div>
        } } @else {
        <p class="no-comments">No comments yet. Be the first!</p>
        }
      </div>
    </div>
    } }
  </div>
</div>
